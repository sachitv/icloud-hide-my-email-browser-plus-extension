# Codex Agent Guide

## Project Snapshot

- **Purpose:** Cross-browser extension that surfaces iCloud Hide My Email workflows across Chromium-based browsers and Firefox.
- **Core UX:** Background service worker coordinates with iCloud, content scripts augment email inputs, popup/options React apps manage aliases and settings.
- **Primary Dependencies:** TypeScript 5, React 19, Tailwind CSS 4, WXT 0.20, `webextension-polyfill`, Fuse.js for search, `uuid` for alias identifiers.

## Repository Layout

- `entrypoints/` WXT HTML and script entry definitions for background, content, popup, options, and user guide bundles.
- `src/` core extension code. Notable modules:
  - `pages/` React entry points for `Background`, `Content`, `Options`, `Popup`, and `Userguide` bundles.
  - `browserUtils.ts` shared helpers for browser/runtime detection.
  - `hooks.ts` reusable React hooks.
  - `commonComponents.tsx` shared UI primitives.
  - `icons.tsx` Font Awesome icon bindings used across popup and options UIs.
  - `iCloudClient.ts` API client handling iCloud requests.
  - `storage.ts` wrapper around extension storage APIs.
  - `messages.ts`, `options.ts`, `rules.json`, and `manifest.json` describe messaging, option defaults, declarative rules, and extension metadata.
- `assets/` static images, icons, and demo GIFs packaged with the build.
- `tests/` Vitest suites covering React pages, helpers, and storage utilities.
- `utils/` node scripts that drive ancillary tooling (license reporting, etc.).
- `build/` output directory regenerated by the build scripts; safe to delete between runs.
- Root configs: `wxt.config.ts`, `tailwind.config.js`, `postcss.config.js`, `tsconfig.json`, `vitest.config.mts`, and `biome.json` control bundling, styling, TypeScript, testing, and linting.

## Tooling & Environment

- Target Node.js 22 LTS.
- TypeScript compiler runs in strict mode with JSX transpiled through WXT's Vite pipeline (see `wxt.config.ts`).
- Styling is authored with Tailwind CSS utilities; global CSS lives beside each page entry (`index.css`).
- WXT manages build/dev workflows and runs `wxt prepare` on postinstall to wire up Manifest V3 artifacts.
- Biome provides linting and formatting (TypeScript/TSX/JSON); Prettier is used for Markdown and SCSS only.

## Commands

Run all commands from the repository root.

- Install dependencies: `npm install` (CI uses `npm ci`; Firefox dev also requires `npm i -g web-ext`).
- Brave dev (default): `npm run start` launches WXT in Brave debug mode; `npm run start:brave` runs standard dev server.
- Chromium dev targets: `npm run start:chrome` or `npm run start:edge` depending on browser, generating the Manifest V3 bundle in `build/`.
- Firefox dev: `npm run start:firefox` launches MV2 tooling; confirm MV3 behaviour with a production build before shipping.
- Production builds: `npm run build` (Brave default), or `npm run build:brave`, `npm run build:chrome`, `npm run build:edge`, `npm run build:firefox`.
- Packaging: `npm run package[:browser]` outputs store-ready ZIPs; `npm run package:sources` zips source bundle.
- Tests: `npm run test` executes the Vitest suite with JSDOM.
- Linting/formatting: `npm run lint` (Biome with auto-fix), `npm run lint:check` (no writes), `npm run biome:format` / `npm run biome:format:check`, `npm run prettier[:check]` for Markdown/SCSS.
- Licenses: `npm run check:licenses` (validate), `npm run report:licenses` (regenerate `ATTRIBUTIONS.md`).

## Coding Conventions

- Language: TypeScript with React function components; keep modules typed and avoid `any`.
- Structure React components per page; share logic via `hooks.ts` or `commonComponents.tsx` instead of cross-importing page-specific files.
- Styling: prefer Tailwind utility classes; fall back to scoped CSS files when necessary.
- Formatting matches Biome/Prettier defaults in the repo: 2-space indentation, single quotes, trailing commas in multiline literals.
- Respect existing manifest constraints (MV3) and ensure background logic remains service-worker friendly.
- When touching storage or network logic, verify compatibility with both Chromium and Firefox runtimes.

## Testing & QA Expectations

- Run `npm run test` locally for Vitest coverage of UI helpers and flows.
- Build verification: `npm run build[:browser]` (and `npm run build:firefox` when relevant) before shipping.
- Manually smoke test critical flows: generating aliases, searching existing aliases (Fuse.js-based search), toggling context menu/autofill settings, and ensuring popup/options render correctly.
- Capture manual test notes and browser versions when preparing PRs.

## Contribution Notes

- Follow conventional commit prefixes (`feat:`, `fix:`, `chore:`) used in history.
- Group related changes and keep refactors scoped to the affected module.
- Lint and formatter checks should pass prior to submitting changes.
- When UI changes affect Popup, Options, or Userguide pages, provide updated screenshots or GIFs mirroring those under `src/assets/img`.
